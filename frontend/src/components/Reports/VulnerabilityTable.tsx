import React, { useState } from 'react';
import { FiAlertTriangle } from 'react-icons/fi';
import { FiChevronDown, FiChevronUp, FiExternalLink, FiInfo } from 'react-icons/fi';
import { Vulnerability } from '../../types';
import { formatDate } from '../../utils/api';

interface VulnerabilityTableProps {
  vulnerabilities: Vulnerability[];
  severity: string;
}

const VulnerabilityTable: React.FC<VulnerabilityTableProps> = ({ vulnerabilities, severity }) => {
  const [expandedRow, setExpandedRow] = useState<string | null>(null);

  const toggleExpand = (id: string) => {
    setExpandedRow(expandedRow === id ? null : id);
  };

  const getSeverityColor = (sev: string | undefined) => {
    if (!sev) return 'text-gray-600 dark:text-gray-400';
    switch (sev.toLowerCase()) {
      case 'critical': return 'text-red-600 dark:text-red-400';
      case 'high': return 'text-orange-600 dark:text-orange-400';
      case 'medium': return 'text-yellow-600 dark:text-yellow-400';
      case 'low': return 'text-blue-600 dark:text-blue-400';
      default: return 'text-gray-600 dark:text-gray-400';
    }
  };

  const getSeverityBgColor = (sev: string | undefined) => {
    if (!sev) return 'bg-gray-50 dark:bg-gray-800/50';
    switch (sev.toLowerCase()) {
      case 'critical': return 'bg-red-50 dark:bg-red-900/20';
      case 'high': return 'bg-orange-50 dark:bg-orange-900/20';
      case 'medium': return 'bg-yellow-50 dark:bg-yellow-900/20';
      case 'low': return 'bg-blue-50 dark:bg-blue-900/20';
      default: return 'bg-gray-50 dark:bg-gray-800/50';
    }
  };

  if (vulnerabilities.length === 0) {
    return (
      <div className="text-center py-8">
        <div className="text-3xl mb-4">âœ…</div>
        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-2">
          No {severity} vulnerabilities found
        </h3>
        <p className="text-gray-600 dark:text-gray-400">
          Great news! No {severity} severity issues were detected.
        </p>
      </div>
    );
  }

  return (
    <div className="overflow-x-auto">
      <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
        <thead>
          <tr>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Port/Service
            </th>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Vulnerability
            </th>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Severity
            </th>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Details
            </th>
          </tr>
        </thead>
        <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
          {vulnerabilities.map((vuln) => (
            <React.Fragment key={vuln.id}>
              <tr 
                className={`hover:bg-gray-50 dark:hover:bg-gray-800/50 cursor-pointer ${
                  expandedRow === vuln.id ? getSeverityBgColor(vuln.severity) : ''
                }`}
                onClick={() => toggleExpand(vuln.id)}
              >
                <td className="px-6 py-4">
                  <div className="flex items-center">
                    <div className="font-mono font-medium text-gray-900 dark:text-white">
                      {vuln.port}
                    </div>
                    <div className="ml-4">
                      <div className="text-sm text-gray-900 dark:text-white">
                        {vuln.service || 'Unknown Service'}
                      </div>
                      {vuln.cve_id && (
                        <div className="text-xs text-gray-500 dark:text-gray-400">
                          CVE: {vuln.cve_id}
                        </div>
                      )}
                    </div>
                  </div>
                </td>
                <td className="px-6 py-4">
                  <div className="text-sm font-medium text-gray-900 dark:text-white">
                    {vuln.name}
                  </div>
                </td>
                <td className="px-6 py-4">
                  <span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${
                    !vuln.severity ? 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200' :
                    vuln.severity === 'critical' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' :
                    vuln.severity === 'high' ? 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200' :
                    vuln.severity === 'medium' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' :
                    'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'
                  }`}>
                    {(vuln.severity || 'unknown').toUpperCase()}
                  </span>
                </td>
                <td className="px-6 py-4">
                  <div className="flex items-center">
                    <button className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                      {expandedRow === vuln.id ? (
                        <FiChevronUp size={20} />
                      ) : (
                        <FiChevronDown size={20} />
                      )}
                    </button>
                    <div className="ml-4 text-xs text-gray-500 dark:text-gray-400">
                      {formatDate(vuln.detected_at)}
                    </div>
                  </div>
                </td>
              </tr>
              
              {/* Expanded Details Row */}
              {expandedRow === vuln.id && (
                <tr className={getSeverityBgColor(vuln.severity)}>
                  <td colSpan={4} className="px-6 py-4">
                    <div className="space-y-4">
                      {/* Description */}
                      <div>
                        <div className="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                          <FiInfo className="mr-2" />
                          Description
                        </div>
                        <p className="text-gray-600 dark:text-gray-400 text-sm">
                          {vuln.description}
                        </p>
                      </div>
                      
                      {/* Remediation */}
                      <div>
                        <div className="text-sm font-medium text-green-700 dark:text-green-300 mb-2">
                          Recommended Remediation
                        </div>
                        <p className="text-gray-600 dark:text-gray-400 text-sm">
                          {vuln.remediation}
                        </p>
                      </div>
                      
                      {/* Technical Details */}
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <div>
                          <div className="text-xs text-gray-500 dark:text-gray-400 mb-1">
                            Port Number
                          </div>
                          <div className="font-mono text-sm text-gray-900 dark:text-white">
                            {vuln.port}
                          </div>
                        </div>
                        <div>
                          <div className="text-xs text-gray-500 dark:text-gray-400 mb-1">
                            Service Detected
                          </div>
                          <div className="text-sm text-gray-900 dark:text-white">
                            {vuln.service || 'Not identified'}
                          </div>
                        </div>
                        <div>
                          <div className="text-xs text-gray-500 dark:text-gray-400 mb-1">
                            Detection Time
                          </div>
                          <div className="text-sm text-gray-900 dark:text-white">
                            {formatDate(vuln.detected_at)}
                          </div>
                        </div>
                        <div>
                          <div className="text-xs text-gray-500 dark:text-gray-400 mb-1">
                            Severity Score
                          </div>
                          <div className={`text-sm font-medium ${getSeverityColor(vuln.severity)}`}>
                            {(vuln.severity || 'unknown').toUpperCase()}
                          </div>
                        </div>
                      </div>
                      
                      {/* CVE Link */}
                      {vuln.cve_id && (
                        <div className="pt-4 border-t border-gray-200 dark:border-gray-700">
                          <a
                            href={`https://nvd.nist.gov/vuln/detail/${vuln.cve_id}`}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="inline-flex items-center text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300"
                          >
                            View CVE details on NVD
                            <FiExternalLink className="ml-1" />
                          </a>
                        </div>
                      )}
                    </div>
                  </td>
                </tr>
              )}
            </React.Fragment>
          ))}
        </tbody>
      </table>
    </div>
  );
};

export default VulnerabilityTable;